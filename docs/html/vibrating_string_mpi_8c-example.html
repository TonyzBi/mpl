<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Message Passing Library: vibrating_string_mpi.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Message Passing Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('vibrating_string_mpi_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">vibrating_string_mpi.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Solves the one-dimensional wave equation via finite differences, MPI version.</p>
<div class="fragment"><div class="line"><span class="comment">// solve one-dimensional wave equation</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;mpi.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> N = 1001;  <span class="comment">// total global number of grid points</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">double</span> L = 1, c = 1, dt = 0.001, t_end = 2.4;</div>
<div class="line"><span class="keyword">enum</span> { left_copy, right_copy };</div>
<div class="line"> </div>
<div class="line"><span class="comment">// update string elongation</span></div>
<div class="line"><span class="keywordtype">void</span> string(<span class="keyword">const</span> <span class="keywordtype">double</span> *u, <span class="keyword">const</span> <span class="keywordtype">double</span> *u_old, <span class="keywordtype">double</span> *u_new, <span class="keywordtype">int</span> N, <span class="keywordtype">double</span> eps) {</div>
<div class="line">  u_new[0] = u[0];</div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; N - 1; ++i)</div>
<div class="line">    u_new[i] = eps * (u[i - 1] + u[i + 1]) + 2.0 * (1.0 - eps) * u[i] - u_old[i];</div>
<div class="line">  u_new[N - 1] = u[N - 1];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> *secure_malloc(<span class="keywordtype">size_t</span> size) {</div>
<div class="line">  <span class="keywordtype">void</span> *p = malloc(size);</div>
<div class="line">  <span class="keywordflow">if</span> (p == NULL)</div>
<div class="line">    MPI_Abort(MPI_COMM_WORLD, EXIT_FAILURE);</div>
<div class="line">  <span class="keywordflow">return</span> p;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// initial elongation</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span> u_0(<span class="keywordtype">double</span> x) {</div>
<div class="line">  <span class="keywordflow">if</span> (x &lt;= 0 || x &gt;= L)</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">  <span class="keywordflow">return</span> exp(-200.0 * (x - 0.5 * L) * (x - 0.5 * L));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// initial velocity</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">double</span> u_0_dt(<span class="keywordtype">double</span> x) {</div>
<div class="line">  <span class="keywordflow">return</span> 0.0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div>
<div class="line">  <span class="keywordtype">int</span> C_rank, C_size, *N_l, *N0_l;</div>
<div class="line">  <span class="keywordtype">double</span> dx = L / (N - 1), eps = dt * dt * c * c / (dx * dx), *u = NULL, *u_l, *u_old_l,</div>
<div class="line">         *u_new_l, *u_temp;</div>
<div class="line">  MPI_Status statuses[4];</div>
<div class="line">  MPI_Request requests[4];</div>
<div class="line">  MPI_Init(&amp;argc, &amp;argv);</div>
<div class="line">  MPI_Comm_size(MPI_COMM_WORLD, &amp;C_size);</div>
<div class="line">  MPI_Comm_rank(MPI_COMM_WORLD, &amp;C_rank);</div>
<div class="line">  N_l = secure_malloc(C_size * <span class="keyword">sizeof</span>(*N_l));</div>
<div class="line">  N0_l = secure_malloc(C_size * <span class="keyword">sizeof</span>(*N0_l));</div>
<div class="line">  <span class="comment">// calculate size and position of local grids</span></div>
<div class="line">  <span class="comment">// local grids include one mirror grid point at each end or the boundary condition</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; C_size; ++i) {</div>
<div class="line">    <span class="comment">// number of local grid points is N_l[C_rank]</span></div>
<div class="line">    N_l[i] = (i + 1) * (N - 2) / C_size - i * (N - 2) / C_size + 2;</div>
<div class="line">    <span class="comment">// position of local</span></div>
<div class="line">    N0_l[i] = i * (N - 2) / C_size;</div>
<div class="line">  }</div>
<div class="line">  u_old_l = secure_malloc((N_l[C_rank]) * <span class="keyword">sizeof</span>(*u_old_l));</div>
<div class="line">  u_l = secure_malloc((N_l[C_rank]) * <span class="keyword">sizeof</span>(*u_l));</div>
<div class="line">  u_new_l = secure_malloc((N_l[C_rank]) * <span class="keyword">sizeof</span>(*u_new_l));</div>
<div class="line">  <span class="comment">// 1st time step uses elongation and velocity</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N_l[C_rank]; ++i) {</div>
<div class="line">    <span class="keywordtype">double</span> x = (i + N0_l[C_rank]) * dx;</div>
<div class="line">    u_old_l[i] = u_0(x);</div>
<div class="line">    u_l[i] = 0.5 * eps * (u_0(x - dx) + u_0(x + dx)) + (1.0 - eps) * u_0(x) + dt * u_0_dt(x);</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">// solve wave equation by using elongation at current time and one step before</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">double</span> t = 2 * dt; t &lt;= t_end; t += dt) {</div>
<div class="line">    string(u_l, u_old_l, u_new_l, N_l[C_rank], eps);</div>
<div class="line">    MPI_Isend(&amp;u_new_l[N_l[C_rank] - 2], 1, MPI_DOUBLE,</div>
<div class="line">              C_rank + 1 &lt; C_size ? C_rank + 1 : MPI_PROC_NULL, right_copy, MPI_COMM_WORLD,</div>
<div class="line">              &amp;requests[0]);</div>
<div class="line">    MPI_Isend(&amp;u_new_l[1], 1, MPI_DOUBLE, C_rank - 1 &gt;= 0 ? C_rank - 1 : MPI_PROC_NULL,</div>
<div class="line">              left_copy, MPI_COMM_WORLD, &amp;requests[1]);</div>
<div class="line">    MPI_Irecv(&amp;u_new_l[0], 1, MPI_DOUBLE, C_rank - 1 &gt;= 0 ? C_rank - 1 : MPI_PROC_NULL,</div>
<div class="line">              right_copy, MPI_COMM_WORLD, &amp;requests[2]);</div>
<div class="line">    MPI_Irecv(&amp;u_new_l[N_l[C_rank] - 1], 1, MPI_DOUBLE,</div>
<div class="line">              C_rank + 1 &lt; C_size ? C_rank + 1 : MPI_PROC_NULL, left_copy, MPI_COMM_WORLD,</div>
<div class="line">              &amp;requests[3]);</div>
<div class="line">    MPI_Waitall(4, requests, statuses);</div>
<div class="line">    u_temp = u_old_l;</div>
<div class="line">    u_old_l = u_l;</div>
<div class="line">    u_l = u_new_l;</div>
<div class="line">    u_new_l = u_temp;</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">// exclude overlapping grid points</span></div>
<div class="line">  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; C_size; ++i) {</div>
<div class="line">    N_l[i] -= 2;</div>
<div class="line">    N0_l[i] += 1;</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">// gather and print data</span></div>
<div class="line">  <span class="keywordflow">if</span> (C_rank == 0)</div>
<div class="line">    u = secure_malloc(N * <span class="keyword">sizeof</span>(*u));</div>
<div class="line">  MPI_Gatherv(u_l + 1, N_l[C_rank], MPI_DOUBLE, u, N_l, N0_l, MPI_DOUBLE, 0, MPI_COMM_WORLD);</div>
<div class="line">  <span class="keywordflow">if</span> (C_rank == 0) {</div>
<div class="line">    u[0] = u[N - 1] = 0;  <span class="comment">// boundary condition</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N; ++i)</div>
<div class="line">      printf(<span class="stringliteral">&quot;%g\n&quot;</span>, u[i]);</div>
<div class="line">  }</div>
<div class="line">  free(u);</div>
<div class="line">  free(u_old_l);</div>
<div class="line">  free(u_l);</div>
<div class="line">  free(u_new_l);</div>
<div class="line">  MPI_Finalize();</div>
<div class="line">  <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
